---
title: "589project"
author: "Rui Mao, Zheng Zhang, Zerui Zhang"
date: "2024-04-19"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, fig.width=8, fig.height=6, fig.align = 'center')
```

## Load Package
```{r warning=FALSE}
library(sf)
library(spatstat)
library(sp)
library(maptools)
library(dplyr)
library(readr)
library(ggplot2)
library(lubridate)
```

## Load Full Data
```{r echo=FALSE}
bird_bc <- read_csv('bc_bird.csv') %>%
  # filter(stateProvince == "British Columbia") %>%
  select_if(~ !all(is.na(.))) %>%
  filter(!is.na(decimalLongitude) & !is.na(decimalLatitude))
# write.csv(bird_bc, "bc_bird.csv", row.names = FALSE)
```

## Species Distribution
```{r}
ggplot(data = bird_bc, aes(x = species, weight = individualCount, fill = iucnRedListCategory)) +
  geom_bar() +
  labs(title = "Total Number of Individual Birds Observed by Species",
       x = "Species",
       y = "Total Number of Individuals") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
rm(bird_bc)
```

## Filter data 
```{r run-once, echo=FALSE}
bird_data <- bird_bc %>%
  mutate(eventDate = ymd(eventDate)) %>%
  filter(year(eventDate) > 2015, species == 'Podiceps auritus') %>%
  select(species, eventDate, individualCount, decimalLatitude, decimalLongitude)
write.csv(bird_data, "bird_data.csv", row.names = FALSE)
```

## Load Data
```{r}
bird_data <- read_csv('bird_data.csv')
load('BC_Covariates.Rda')
window = DATA$Window
```

## Podiceps auritus Observations by Season
```{r}
bird_data$eventDate <- as.Date(bird_data$eventDate, format = "%Y-%m-%d")
bird_data$season <- case_when(
  month(bird_data$eventDate) %in% 3:5   ~ "Spring",
  month(bird_data$eventDate) %in% 6:8   ~ "Summer",
  month(bird_data$eventDate) %in% 9:11  ~ "Autumn",
  month(bird_data$eventDate) %in% c(12, 1:2) ~ "Winter"
)
ggplot(bird_data, aes(x = season)) +
  geom_bar() +
  labs(title = "Distribution of Podiceps auritus Observations by Season",
       x = "Season",
       y = "Count of Observations")
```

## Podiceps auritus Observations by Year
```{r}
bird_data$year <- as.integer(format(as.Date(bird_data$eventDate, "%Y-%m-%d"), "%Y"))

ggplot(bird_data, aes(x = factor(year))) +
  geom_bar(aes(fill = season)) +
  labs(title = "Distribution of Observations by and Year",
       x = "Year",
       y = "Count of Observations")
```


## ppp Object
```{r}
bird_sf <- st_as_sf(bird_data, coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)
bc_albers_crs_string <- "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs"
bird_albers <- st_transform(bird_sf, crs = bc_albers_crs_string)
```

```{r}
bird <- ppp(x = st_coordinates(bird_albers)[, 1], 
                y = st_coordinates(bird_albers)[, 2],
                window = as.owin(window),
                marks = as.factor(bird_albers$season))
plot(bird, cols = c("green", "cyan", "tan", "deeppink"))
```

```{r}
bird_year <- ppp(x = st_coordinates(bird_albers)[, 1], 
                y = st_coordinates(bird_albers)[, 2],
                window = as.owin(window),
                marks = as.factor(bird_albers$year))
plot(bird_year, cols = rainbow(length(unique(bird_albers$year))))
```

```{r}
bird_ppp <- ppp(x = st_coordinates(bird_albers)[, 1], 
                y = st_coordinates(bird_albers)[, 2],
                window = as.owin(window))
plot(bird_ppp)
```

## Spatially inhomogeneous $\lambda$
```{r}
Q <- quadratcount(bird_ppp,
                  nx = 5,
                  ny = 5)

plot(bird_ppp,
     pch = 16,
     cex = 0.5,
     cols = "#046C9A")

plot(Q, cex = 1.2, col = "red", add = T)
```

## Intensity
```{r}
plot(intensity(Q, image = T),
     main = "Birds intensity")

plot(bird_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = T)

plot(bird_ppp,
     pch = 16,
     cex = 0.5,
     cols = "black",
     add = T)
```

```{r}
quadrat.test(Q)
```

The small p-value suggests that there is a significant deviation from homogeneity.

## Kernel estimation
```{r}
#Density estimation of lambda(u)
lambda_u_hat <- density(bird_ppp)

#Plot the output Note the use of image = TRUE
plot(lambda_u_hat,
     main = "Kernel estimate of Birds intensity")

plot(bird_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = T)

plot(bird_ppp,
     pch = 16,
     cex = 0.5,
     cols = "black",
     add = T)
```

## Hot spot analysis
```{r}
# Estimate R
R <- bw.ppl(bird_ppp)
#Calculate test statistic
LR <- scanLRTS(bird_ppp, r = R)

plot(LR)
```

```{r}
#Compute local p-values
pvals <- eval.im(pchisq(LR,
                        df = 1,
                        lower.tail = FALSE))

plot(pvals, main = "Local p-values")
```

## Relationships with covariates
```{r}
elev <- DATA$Elevation
forest <- DATA$Forest
hfi <- DATA$HFI
water <- DATA$Dist_Water
rho_elev <- rhohat(bird_ppp, elev)
rho_forest <- rhohat(bird_ppp, forest)
rho_hfi <- rhohat(bird_ppp, hfi)
rho_water <- rhohat(bird_ppp, water)
```

```{r}
par(mfrow = c(2,2))
plot(rho_elev, xlim=c(0, 1500),
     main = "",
     xlab = "Elevation (m)")
plot(rho_forest,
     main = "",
     xlab = "Forest Cover (percentage)")
plot(rho_hfi,
     main = "",
     xlab = "HFI")
plot(rho_water, xlim=c(0, 16000),
     main = "",
     xlab = "Water distribution")
```

# K-function
```{r}
E_bird <- envelope(bird_ppp,
                  Kest,
                  correction="border",
                  rank = 1,
                  nsim = 19,
                  fix.n = T)
plot(E_bird,
     main = "",
     lwd = 2)
```

## PCF
```{r}
pcf_bird_hom <- envelope(bird_ppp,
                          pcf,
                          simulate = expression(rpoispp(density.ppp(bird_ppp))),
                          rank = 1,
                          nsim = 19)
pcf_bird_inhom <- envelope(bird_ppp,
                          pcfinhom,
                          simulate = expression(rpoispp(density.ppp(bird_ppp))),
                          rank = 1,
                          nsim = 19)
par(mfrow = c(1,2))
plot(pcf_bird_hom, main = 'homogeneous pcf')
plot(pcf_bird_inhom,  main = 'inhomogeneous pcf')
```

## Collinearity
```{r}
cor.im(elev, forest, hfi, water, use = 'complete.obs')
```

## Model fitting
```{r}
fit1 <- ppm(bird_ppp, ~ forest + I(forest^2) + water)
fit1
plot(fit1,
     se = FALSE,
     superimpose = FALSE)

plot(bird_ppp,
     pch = 16,
     cex = 0.5,
     cols = "green",
     add = TRUE)
```

```{r}
quadrat.test(fit1, nx = 4, ny = 2)
```

```{r}
par_res_water <- parres(fit1, "water")
par_res_forest <- parres(fit1, "forest")

par(mfrow = c(1,2))
plot(par_res_water,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Water distribution")
plot(par_res_forest,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Forest(percent)")
```


```{r}
fit2 <- ppm(bird_ppp, ~ water)
fit2
plot(fit2,
     se = FALSE,
     superimpose = FALSE)

plot(bird_ppp,
     pch = 16,
     cex = 0.5,
     cols = "green",
     add = TRUE)
```

```{r}
par_res_water <- parres(fit2, "water")

plot(par_res_water,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Water distribution")
```

```{r}
print(AIC(fit1))
print(AIC(fit2))
print(anova(fit1, fit2, test="LRT"))
```

